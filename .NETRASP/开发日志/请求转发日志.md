# 请求转发日志

## Note

- [Agent 数据传输格式](http://cd.xmirror.com.cn:89/pages/viewpage.action?pageId=36110338)
- 不使用`http`,使用`socket`发送接收数据

## 转发地址

## 参数

| Tomcat | /    | 192.168.172.138 | 9090 | EAB1OGMIFVGRGICI | NUZFOFSZCWUXGPLT |
| ------ | ---- | --------------- | ---- | ---------------- | ---------------- |
| server | path | ip              | port | 密码             | AgentId          |

## Json 格式检查

### XJsonData

```json
{
  "id": "1UB11YMBATNOZFBH",
  "ts": 1595834515,
  "msg": {
    "result": {
      "urls": [
        {
          "method": "GET",
          "url": "https://localhost:5001/",
          "data": "",
          "headers": {
            "Cookie": null,
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9",
            "Upgrade-Insecure-Requests": "1",
            "Connection": null,
            "Referer": null,
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.89 Safari/537.36",
            "Host": "localhost:5001",
            "Accept-Encoding": "gzip, deflate, br",
            "Accept-Language": "zh-CN,zh;q=0.9,en;q=0.8"
          },
          "iastrange": ["sql"]
        }
      ]
    },
    "cmd": 4001
  }
}
```

### XAesResult

```json
{
  "id": "DXGVUYDRJZDKBVIL",
  "aes": "sUnFfWqbSvNxYMDKlHt43NPBXKj8FUFZQa36V+UXXkpTmzqorL8vT7wqGw+/Nek9f/CwRYnt5d2QT6H4jQELPfeMjQVQv+pyJDRxuqqYhqZXkOepWnODRVYtSmHS7q8WqCLd/jdAMVTXWNVEIHfPxZ6HAtPQKFP6AsHhCcWbHZ5IuUs34IUxCn8cm4IsDj+xyzKgUYtwmz8pt7CrGhWKgcQw81oA3GtTuF20Vfp/Nt8Sb/sn7GwAuys3NVzuxazlIEyIZ/W4d3n83sgzQyibxVT9xCc3PZouOf7bIg+TUkwv15OGlBfHzRRT1IrpDOngfojSgcXjj4+33yrHaetRA5YW81QraFvv",
  "aestag": "t98qx2nrUQOWFvNUK2hb7w==",
  "aesnonce": "dp3biE6ndhY5sKOv"
}
```

```json
{
  "id": "DXGVUYDRJZDKBVIL",
  "aes": "sUnFfWqbSvNxYMDKlHt43NPBXKj8FUFZQa36V+UXXkpTmzqorL8vT7wqGw+/Nek9f/CwRYnt5d2QT6H4jQELPfeMjQVQv+pyJDRxuqqYhqZXkOepWnODRVYtSmHS7q8WqCLd/jdAMVTXWNVEIHfPxZ6HAtPQKFP6AsHhCcWbHZ5IuUs34IUxCn8cm4IsDj+xyzKgUYtwmz8pt7CrGhWKgcQw81oA3GtTuF20Vfp/Nt8Sb/sn7GwAuys3NVzuxazlIEyIZ/W4d3n83sgzQyibxVT9xCc3PZouOf7bIg+TUkwv15OGlBfHzRRT1IrpDOngfojSgcXjj48=",
  "aestag": "t98qx2nrUQOWFvNUK2hb7w==",
  "aesnonce": "dp3biE6ndhY5sKOv"
}
```

## Java实现

```java
public static String[] encryptGCMBase64BC(String clearText, String password,String nonce){
        try {
            // 1 获取加密密文字节数组
            byte[] cipherTextBytes = encryptGCMBC(clearText.getBytes(), password.getBytes(),nonce.getBytes());
            byte[] cipherBytes = Arrays.copyOfRange(cipherTextBytes,0,cipherTextBytes.length-TAG_LENGTH);
            byte[] tagBytes = Arrays.copyOfRange(cipherTextBytes,cipherTextBytes.length-TAG_LENGTH,cipherTextBytes.length);

            String cipher = new String(Base64.encode(cipherBytes));
            String tag = new String(Base64.encode(tagBytes));

            // 3 返回BASE64输出的密文
            return new String[]{cipher,tag};
        } catch (Exception e) {
            e.printStackTrace();
        }
        // 加密错误 返回null
        return null;
    }
    public static byte[] encryptGCMBC(byte[] plaintext, byte[] key, byte[] IV) throws Exception
    {
        GCMBlockCipher c = new GCMBlockCipher(new AESEngine());
        AEADParameters aeadParameters = new AEADParameters(new KeyParameter(key), TAG_LENGTH*8, IV);
        c.init(true, aeadParameters);

        byte[] out = new byte[plaintext.length+TAG_LENGTH];

        int len = c.processBytes(plaintext, 0, plaintext.length, out, 0);

        // 加密数据, 返回密文
        c.doFinal(out,len);

        //c.doFinal(out, 0);
        return out;
    }
```
